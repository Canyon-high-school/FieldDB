<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: confidentiality_encryption/Confidential.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: confidentiality_encryption/Confidential.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>if ('undefined' === typeof window) {
  var window = {};
}
(function(exports) {
    var CryptoJS = exports.CryptoJS || CryptoJS || require("../../backbone_client/libs/Crypto_AES");
    var OPrime = exports.OPrime || OPrime || require("../../backbone_client/libs/OPrime");



    
      /**
       * @class Confidential 
       * @name Confidential 
       *
       * @description makes it possible to generate pass phrases (one per
       *        corpus) to encrypt and decrypt confidential data points. The
       *        confidential data is stored encrypted, and can only be decrypted
       *        if one has the corpus' secret key, or if one is logged into the
       *        system with their user name and password. This allows the corpus
       *        to be shared with anyone, with out worrying about confidential
       *        data or consultant stories being publically accessible. We are
       *        using the AES cipher algorithm.
       *
       * The Advanced Encryption Standard (AES) is a U.S. Federal Information
       * Processing Standard (FIPS). It was selected after a 5-year process where
       * 15 competing designs were evaluated.
       *
       * &lt;a href="http://code.google.com/p/crypto-js/">More information on
       * CryptoJS&lt;/a>
       * 
       * @extends Object
       *
       * @constructs
       *
       */
    function Confidential() {
      Object.call(this);
    }

    Confidential.prototype = Object.create(Object.prototype);


      Confidential.prototype.initialize = function() {
        if (OPrime.debugMode) OPrime.debug("Initializing confidentiality module");

        //      var encryptedMessage = this.encrypt("hi this is a longer message.");
        //      console.log("encrypted" + encryptedMessage);
        //
        //      var decryptedMessage = this.decrypt(encryptedMessage);
        ////      console.log("decrypted:" + decryptedMessage);
        if (this.filledWithDefaults) {
          this.fillWithDefaults();
          delete this.filledWithDefaults;
        }

      };

      Confidential.prototype.fillWithDefaults = function() {
        if (this.secretkey == "This should be a top secret pass phrase.") {
          this.secretkey = this.secretKeyGenerator();
        }
      };

      Confidential.prototype.defaults = {
        secretkey: "This should be a top secret pass phrase."
      };

      Confidential.prototype.decryptedMode = false;

      Confidential.prototype.turnOnDecryptedMode = function(callback) {
        this.decryptedMode = false;
        if (typeof callback == "function") {
          callback();
        }
      };

      Confidential.prototype.turnOnDecryptedMode = function(callback) {
        var self = this;
        if (!this.decryptedMode) {
          if (window.appView) {
            window.appView.authView.showQuickAuthenticateView(function() {
              //This happens after the user has been authenticated. 
              self.decryptedMode = true;
              if (typeof callback == "function") {
                callback();
              }
            });
          }
        }
      };

      // Internal models: used by the parse function
      Confidential.prototype.internalModels = {
        // There are no nested models
      };

      Confidential.prototype.saveAndInterConnectInApp = function(callback) {

        if (typeof callback == "function") {
          callback();
        }
      };
      /**
       * Encrypt accepts a string (UTF8) and returns a CryptoJS object, in base64
       * encoding so that it looks like a string, and can be saved as a string in
       * the corpus.
       *
       * @param message
       *          A UTF8 string
       * @returns Returns a base64 string prefixed with "confidential" so that the
       *          views can choose to not display the entire string for the user.
       */
      Confidential.prototype.encrypt = function(message) {
        var result = CryptoJS.AES.encrypt(message, this.secretkey);
        // return the base64 version to save it as a string in the corpus
        return "confidential:" + btoa(result);

      };

      /**
       * Decrypt uses this object's secret key to decode its parameter using the
       * AES algorithm.
       *
       * @param encrypted
       *          A base64 string prefixed (or not) with the word "confidential"
       * @returns Returns the encrypted result as a UTF8 string.
       */
      Confidential.prototype.decrypt = function(encrypted) {
        var resultpromise = encrypted;
        if (!this.decryptedMode) {
          var confid = this;
          this.turnOnDecryptedMode(function() {
            encrypted = encrypted.replace("confidential:", "");
            // decode base64
            encrypted = atob(encrypted);
            resultpromise = CryptoJS.AES.decrypt(encrypted, confid.secretkey).toString(CryptoJS.enc.Utf8);
            return resultpromise;
          });
        } else {
          encrypted = encrypted.replace("confidential:", "");
          // decode base64
          encrypted = atob(encrypted);
          resultpromise = CryptoJS.AES.decrypt(encrypted, this.secretkey).toString(CryptoJS.enc.Utf8);
          return resultpromise;
        }
      };

      /**
       * The secretkeygenerator uses a "GUID" like generation to create a string
       * for the secret key.
       *
       * @returns {String} a string which is likely unique, in the format of a
       *          Globally Unique ID (GUID)
       */
      Confidential.prototype.secretKeyGenerator = function() {
        var S4 = function() {
          return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        };
        return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
      };


      Confidential.prototype.constructor = Confidential;

      exports.Confidential = Confidential;

    })(window || exports)
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-FieldDB.html">FieldDB</a></li></ul><h3>Classes</h3><ul><li><a href="Activity.html">Activity</a></li><li><a href="App.html">App</a></li><li><a href="AppRouter.html">AppRouter</a></li><li><a href="AudioVideo.html">AudioVideo</a></li><li><a href="Authentication.html">Authentication</a></li><li><a href="Comment.html">Comment</a></li><li><a href="Comments.html">Comments</a></li><li><a href="Confidential.html">Confidential</a></li><li><a href="Consultant.html">Consultant</a></li><li><a href="Consultants.html">Consultants</a></li><li><a href="Conversation.html">Conversation</a></li><li><a href="Conversations.html">Conversations</a></li><li><a href="Corpus.html">Corpus</a></li><li><a href="Corpuses.html">Corpuses</a></li><li><a href="CorpusMask.html">CorpusMask</a></li><li><a href="DataList.html">DataList</a></li><li><a href="DataLists.html">DataLists</a></li><li><a href="Datum.html">Datum</a></li><li><a href="DatumField.html">DatumField</a></li><li><a href="DatumFields.html">DatumFields</a></li><li><a href="Datums.html">Datums</a></li><li><a href="DatumState.html">DatumState</a></li><li><a href="DatumStates.html">DatumStates</a></li><li><a href="DatumTag.html">DatumTag</a></li><li><a href="Export.html">Export</a></li><li><a href="HotKey.html">HotKey</a></li><li><a href="HotKeys.html">HotKeys</a></li><li><a href="Import.html">Import</a></li><li><a href="InsertUnicode.html">InsertUnicode</a></li><li><a href="InsertUnicodes.html">InsertUnicodes</a></li><li><a href="Lexicon.html">Lexicon</a></li><li><a href="LexiconNode.html">LexiconNode</a></li><li><a href="LexiconNodes.html">LexiconNodes</a></li><li><a href="Permission.html">Permission</a></li><li><a href="Permissions.html">Permissions</a></li><li><a href="ReportBot.html">ReportBot</a></li><li><a href="Search.html">Search</a></li><li><a href="Session.html">Session</a></li><li><a href="Sessions.html">Sessions</a></li><li><a href="Team.html">Team</a></li><li><a href="User.html">User</a></li><li><a href="UserApp.html">UserApp</a></li><li><a href="UserMask.html">UserMask</a></li><li><a href="UserPreference.html">UserPreference</a></li><li><a href="UserRouter.html">UserRouter</a></li><li>{String: Exercise}</li></ul><h3>Global</h3><ul><li><a href="global.html#baseSchema">baseSchema</a></li><li><a href="global.html#CorpusConnection">CorpusConnection</a></li><li><a href="global.html#newCorpusConnection">newCorpusConnection</a></li><li><a href="global.html#validateDbnameFormat">validateDbnameFormat</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Sun Feb 09 2014 10:49:22 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
